#include <xc.h>
#include <pic18f4550.h>

#pragma config PBADEN = OFF
#pragma config FOSC = HS
#pragma config PWRT = OFF
#pragma config BOR = OFF
#pragma config ICPRT = OFF
#pragma config LVP = OFF
#pragma config WDT = OFF
#pragma config DEBUG = OFF
#pragma config CPUDIV = OSC1_PLL2

#define _XTAL_FREQ 8000000

void send_cmd(unsigned char cmd){
    TRISB = 0;
    PORTB = 0;
    PORTBbits.RB4 = 0;
    PORTBbits.RB5 = 1;
    PORTB = PORTB | (cmd >> 4);
    PORTBbits.RB5 = 1;
    __delay_us(30);
    PORTBbits.RB5 = 0;
    PORTB = 0;
    PORTBbits.RB4 = 0;
    PORTB = PORTB | (cmd & 0x0F);
    PORTBbits.RB5 = 1;
    __delay_us(30);
    PORTBbits.RB5 = 0;
    __delay_ms(2);
}

void send_data(unsigned char data){
    TRISB = 0;
    PORTB = 0;
    PORTBbits.RB4 = 1;
    PORTBbits.RB5 = 0;
    PORTB = PORTB | (data >> 4);
    PORTBbits.RB5 = 1;
    __delay_us(30);
    PORTBbits.RB5 = 0;
    PORTB = 0;
    PORTBbits.RB4 = 1;
    PORTB = PORTB | (data & 0x0F);
    PORTBbits.RB5 = 1;
    __delay_us(30);
    PORTBbits.RB5 = 0;
    __delay_ms(2);
}

void lcd_init(){
    send_cmd(0x30);
    send_cmd(0x20);
    send_cmd(0x28);
    send_cmd(0x01);
    send_cmd(0x06);
    send_cmd(0x0C);
}

void main(void){
    unsigned int adValue, digit0, digit1, digit2, digit3;

    TRISB = 0;
    TRISAbits.TRISA0 = 1;

    ADCON0 = 0b00000001;     
    ADCON1 = 0b00001000;     
    ADCON2 = 0b10000100;    

    lcd_init();
    send_cmd(0x80);
    send_cmd(0x01);

    while (1){
        __delay_ms(10);
        ADCON0bits.GO = 1;
        while (ADCON0bits.DONE == 1);

        adValue = ADRESL + (ADRESH * 256);

        digit0 = (unsigned char)adValue % 10 + 0x30;
        adValue = adValue / 10;

        digit1 = (unsigned char)adValue % 10 + 0x30;
        adValue = adValue / 10;

        digit2 = (unsigned char)adValue % 10 + 0x30;
        adValue = adValue / 10;

        digit3 = (unsigned char)adValue % 10 + 0x30;

        send_data(digit3);
        send_data(digit2);
        send_data(digit1);
        send_data(digit0);

        __delay_ms(500);

        send_cmd(0x01);   // clear
        send_cmd(0x80);   // set cursor
        __delay_ms(250);
    }

    return;
}